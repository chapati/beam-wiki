# Miner proposal
## Структура и интерфейсы

Структура майнера, судя по Zcash и grin, достаточно типична. 
Майнер зависит от
* пула транзакций
* блокчейна
* и от кошелька.

Входными данными для PoW является заголовок блока (но без учета данных для PoW), начальный _nonce_ и _difficlty_.
Заголовок *grin* отлично подходит, так же стоит заметить, что в заголовок входит и параметр сложности _difficlty_

Выходом являются:
* _nonce_ - 256-битное число (32 байта)
* _solution_ - массив байт являющихся частью решения PoW (x<sub>_i_</sub>) (для N=200, K=9, количество решений 2^K == 512, длина |x<sub>_i_</sub>| == n/(k+1) + 1 == 21 бит, итого размер PoW = (512 * 21) / 8 == 1344 байта)

Причем полученное решение должно удовлетворять условиям задачи: 
1. xor от blake2 хэшей от H(BlockHeader_without_PoW || _nonce_|| x<sub>_i_</sub>) должен быть нулевым
2. хэш blake2 от полученного заголовка H(BlockHeader_with_PoW) должен иметь _difficlty_ нулей

эти данные добавляются к заголовку блока (+1376 байт)

## Основной цикл работы майнера (очень крупно)
1. получить у _пула транзакций_ список транзакций доступных для майнинга
2. посчитать комиссию для этих транзакций
3. попросить у _кошелька_, чтобы он сформировал транзакцию для вознаграждения и для комиссии (ядро и выход)
4. сформировать новый блок для этих транзакций, на основании последнего блока в _блокчейне_, на этом шаге выбирается и заполняется поле _difficlty_ (так делается в grin и в Zcash, алгоритм в принципе выбора может менятся, в Zcash оно зависит от средней сложности последних нескольких блоков и времени нахождения предыдущего блока; в grin все немного менее очевидно, ребята экспериментируют)
5. получитить у _блокчейна_ *merkle root hash* и добавить в блок
6. теперь у нас есть вся необходимая информация для майнинга, выбираем случайный начальный _nonce_, и скармливаем сериализованный данные заголовка блока в PoW
7. если все хорошо, мы решили задачу, уложились в отведенное время и нас не прервали, то получаемый блок отправляется в _блокчейн_, в противном случае начинаем формировать блок заново.

_Замечание_: В _grin_ подбор _nonce_ происходит в главном цикле майнера, а не внутри PoW

Пополнение пула транзакций, а также добавление и обновление _блокчейна_, широковещательная рассылка в прямые обязанности майнера не входят, но он слушает изменения в системе.
Если во время работы над PoW голова блокчейна поменялась, то майнеру нет смысла рабатать с устаревшими данными, поэтому можно предусмотреть возможность превырания майнинга (это сделано в Zcash).

стркутруно должно выглядет так

![стркутруно должно выглядет так](https://user-images.githubusercontent.com/1101448/38032575-adba41b6-32a6-11e8-8a4f-b0b4ab90eff7.png)

## Собственно, что планируется делать
1. Минимально необходимый интерфейс для _TxPool_
  - получение списка транзакций доступных для майнинга
2. Минимально необходимый интерфейс для _блокчейна_
  - получение головы цепочки
  - уведомление об изменении этой самой головы, чтобы можно было прервать майнинг
  - установка Merkle root для нового блока
  - добавление нового блока в систему
3. Интерфейс для взаимодействия с кошельком
  - получить данные о транзакции вознаграждения и комиссии. (grin напрямую обращается к кошельку через REST API, но гибче просто спрятаться за интерфейсом)
4. Интерфейс для подключения PoW.
  - получить решение для блока. Эта часть может прятать достаточно много нюансов реализации, как то выполнение на одном/нескольких CPU/GPU и пр. Поэтому эта часть интерфейса будет отделена от проверки
  - проверить решение. Эта функция достаточно простая и используется не только в майнере
5. Собственно PoW
  - сейчас выдрана соответствующая реализация из Zcash, и спрятана за вышеозначенным интерфейсом
  - для хэшей blake2 взят _libsodium_, но видимо нужно только blake2 из него взять
5. Собственно майнер.
  - содержит цикл поиска решений/формирования блока, соответственно должен знать о стркутуре блока и его заголовка
  - следит да _блокчейном_
  - держит ссылку на _пул транзакций_, знает стркутуру транзакции
6. Также нужно подумать над конфигурацией(N, K, какой вариант PoW включать) и над статистикой




